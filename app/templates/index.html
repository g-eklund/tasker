<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>House Hunt Challenge</title>
    <link rel="stylesheet" href="{{ url_for('static', path='/css/styles.css') }}">
    <style>
        body {
            font-family: 'Comic Sans MS', cursive, sans-serif;
            text-align: center;
            background-color: #f0f8ff;
            margin: 0;
            padding: 20px;
            color: #333;
        }
        
        .points-counter {
            position: fixed;
            top: 10px;
            right: 20px;
            background-color: #4b0082;
            color: white;
            padding: 10px 15px;
            border-radius: 25px;
            font-size: 1.2rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 100;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            color: #4b0082;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .subtitle {
            color: #6a5acd;
            font-size: 1.2rem;
            margin-bottom: 30px;
        }
        
        .btn-primary {
            background-color: #4b0082;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
        }
        
        .btn-primary:hover {
            background-color: #6a5acd;
            transform: scale(1.05);
        }
        
        .challenge-section {
            margin-top: 20px;
        }
        
        .challenge-image {
            max-width: 80%;
            margin: 20px auto;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        .timer {
            font-size: 2rem;
            color: #ff4500;
            margin: 20px 0;
        }
        
        .camera-section {
            margin: 20px 0;
        }
        
        #camera-feed {
            width: 100%;
            max-width: 500px;
            border-radius: 10px;
            margin: 0 auto;
            display: block;
        }
        
        .feedback {
            font-size: 1.5rem;
            margin: 20px 0;
        }
        
        .success {
            color: #008000;
        }
        
        .failure {
            color: #ff0000;
        }

        .hidden {
            display: none;
        }
        
        .progress-container {
            width: 100%;
            margin: 15px auto;
            background-color: #e0e0e0;
            border-radius: 20px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);
        }
        
        .progress-bar {
            height: 20px;
            border-radius: 20px;
            transition: width 0.3s ease;
            text-align: center;
            line-height: 20px;
            color: white;
            font-weight: bold;
        }
        
        .time-progress {
            background-color: #ff4500;
        }
        
        .points-progress {
            background-color: #4b0082;
        }
    </style>
</head>
<body>
    <div id="total-points" class="points-counter">Total Points: 0</div>
    <div class="container">
        <h1>House Hunt Challenge</h1>
        <p class="subtitle">Find these items as fast as you can!</p>
        
        <div id="session-progress" class="progress-container" style="margin-bottom: 30px;">
            <div id="points-progress-bar" class="progress-bar points-progress" style="width: 0%;"></div>
        </div>
        
        <div id="start-section">
            <button id="new-challenge-btn" class="btn-primary">Start New Challenge</button>
        </div>
        
        <div id="challenge-section" class="hidden challenge-section">
            <h2>Find this item:</h2>
            <h3 id="item-name"></h3>
            <img id="challenge-image" class="challenge-image" alt="Item to find">
            <div class="timer">Time: <span id="timer">60</span> seconds</div>
            <div class="progress-container">
                <div id="time-progress-bar" class="progress-bar time-progress" style="width: 100%;"></div>
            </div>
            
            <div class="camera-section">
                <video id="camera-feed" autoplay playsinline></video>
                <canvas id="photo-canvas" style="display:none;"></canvas>
                <button id="take-photo-btn" class="btn-primary">Take Photo</button>
            </div>
            
            <div id="feedback" class="feedback"></div>
        </div>
        
        <div id="result-section" class="hidden">
            <h2 id="result-message"></h2>
            <div id="points-display"></div>
            <button id="play-again-btn" class="btn-primary">Play Again</button>
        </div>
    </div>

    <script>
    // Configuration values exposed from backend
    const CHALLENGE_DURATION = {{ challenge_duration|int }};
    const MAX_POINTS_THIS_CHALLENGE = {{ max_points_per_challenge|int }};
    const MAX_SESSION_POINTS = {{ max_points|int }};
    // For UI config (color, etc) you can do: const UI_CONFIG = {{ ui|tojson }};

    let currentChallengeId = null;
    let timerInterval = null;
    let mediaStream = null;
    let totalSessionPoints = parseInt(localStorage.getItem('totalSessionPoints') || '0');
    let maxSessionPoints = MAX_SESSION_POINTS; // Target for the progress bar

    // If someone changes config, ensure maxSessionPoints is always kept synced
    // You may want to update localStorage too if goal changes mid-session
    
        document.getElementById('new-challenge-btn').addEventListener('click', startNewChallenge);
        document.getElementById('take-photo-btn').addEventListener('click', takePhoto);
        document.getElementById('play-again-btn').addEventListener('click', resetGame);
        
        // Update the points display
        function updatePointsDisplay() {
            document.getElementById('total-points').textContent = `Total Points: ${totalSessionPoints}`;
            
            // Update progress bar
            const progressPercent = Math.min(100, (totalSessionPoints / maxSessionPoints) * 100);
            const pointsBar = document.getElementById('points-progress-bar');
            pointsBar.style.width = `${progressPercent}%`;
            pointsBar.textContent = "";
            
            // Check if the goal is reached
            if (totalSessionPoints >= maxSessionPoints) {
                // Save the final score to localStorage for the completion page
                localStorage.setItem('finalScore', totalSessionPoints.toString());
                // Redirect to the challenge complete page
                window.location.href = '/challenge-complete';
            }
        }
        
        async function startNewChallenge() {
            // Reset UI
            document.getElementById('start-section').classList.add('hidden');
            document.getElementById('challenge-section').classList.remove('hidden');
            document.getElementById('result-section').classList.add('hidden');
            document.getElementById('feedback').textContent = '';
            
            try {
                // Request a new challenge from the API
                const response = await fetch('/api/new-challenge', {
                    method: 'POST'
                });
                
                if (!response.ok) throw new Error('Failed to start challenge');
                
                const data = await response.json();
                currentChallengeId = data.challenge_id;
                
                // Display challenge details
                document.getElementById('item-name').textContent = data.item.name;
                document.getElementById('challenge-image').src = `/static/images/${data.item.image}`;
                
                // Start timer
                let timeRemaining = data.time_limit || CHALLENGE_DURATION;
                let maxTime = data.time_limit || CHALLENGE_DURATION;
                document.getElementById('timer').textContent = timeRemaining;
                
                // Reset time progress bar
                const timeBar = document.getElementById('time-progress-bar');
                timeBar.style.width = '100%';
                
                clearInterval(timerInterval);
                timerInterval = setInterval(() => {
                    timeRemaining--;
                    document.getElementById('timer').textContent = timeRemaining;
                    
                    // Update time progress bar
                    const timePercent = (timeRemaining / maxTime) * 100;
                    timeBar.style.width = `${timePercent}%`;
                    
                    if (timeRemaining <= 0) {
                        clearInterval(timerInterval);
                        handleTimeExpired();
                    }
                }, 1000);
                
                // Start camera
                await startCamera();
                
            } catch (error) {
                console.error('Error starting challenge:', error);
                alert('Failed to start challenge. Please try again.');
                resetGame();
            }
        }
        
        async function startCamera() {
            try {
                const constraints = {
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                };
                
                mediaStream = await navigator.mediaDevices.getUserMedia(constraints);
                const videoElement = document.getElementById('camera-feed');
                videoElement.srcObject = mediaStream;
            } catch (error) {
                console.error('Error accessing camera:', error);
                alert('Unable to access camera. Please check permissions.');
            }
        }
        
        function stopCamera() {
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
                mediaStream = null;
            }
        }
        
        async function takePhoto() {
            if (!currentChallengeId) return;
            
            const video = document.getElementById('camera-feed');
            const canvas = document.getElementById('photo-canvas');
            const feedback = document.getElementById('feedback');
            
            // Set canvas dimensions to match video
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            // Draw the current video frame on the canvas
            const context = canvas.getContext('2d');
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // Convert canvas to blob
            canvas.toBlob(async (blob) => {
                // Create form data with the image
                const formData = new FormData();
                formData.append('photo', blob, 'photo.jpg');
                
                try {
                    // Submit the photo
                    const response = await fetch(`/api/submit-photo/${currentChallengeId}`, {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (!response.ok) throw new Error('Failed to submit photo');
                    
                    const data = await response.json();
                    
                    if (data.status === 'success') {
                        feedback.textContent = data.message;
                        feedback.className = 'feedback success';
                        clearInterval(timerInterval);
                        stopCamera();
                        
                        // Add points to the session total
                        totalSessionPoints += data.points;
                        // Store in localStorage for persistence
                        localStorage.setItem('totalSessionPoints', totalSessionPoints.toString());
                        updatePointsDisplay();
                        
                        // Show results
                        document.getElementById('challenge-section').classList.add('hidden');
                        document.getElementById('result-section').classList.remove('hidden');
                        document.getElementById('result-message').textContent = 'Great job! You found it!';
                        document.getElementById('points-display').textContent = `You earned ${data.points} points!`;
                    } else {
                        feedback.textContent = data.message;
                        feedback.className = 'feedback failure';
                        
                        if (data.completed) {
                            clearInterval(timerInterval);
                            stopCamera();
                            
                            // Show failed result
                            document.getElementById('challenge-section').classList.add('hidden');
                            document.getElementById('result-section').classList.remove('hidden');
                            document.getElementById('result-message').textContent = 'Time\'s up!';
                            document.getElementById('points-display').textContent = 'Better luck next time!';
                        }
                    }
                } catch (error) {
                    console.error('Error submitting photo:', error);
                    feedback.textContent = 'Error submitting photo. Please try again.';
                    feedback.className = 'feedback failure';
                }
            }, 'image/jpeg', 0.95);
        }
        
        async function handleTimeExpired() {
            const feedback = document.getElementById('feedback');
            feedback.textContent = 'Time\'s up!';
            feedback.className = 'feedback failure';
            
            stopCamera();
            
            // Show failed result
            document.getElementById('challenge-section').classList.add('hidden');
            document.getElementById('result-section').classList.remove('hidden');
            document.getElementById('result-message').textContent = 'Time\'s up!';
            document.getElementById('points-display').textContent = 'Better luck next time!';
        }
        
        function resetGame() {
            // Stop any running timers and camera
            clearInterval(timerInterval);
            stopCamera();
            
            // Reset UI
            document.getElementById('start-section').classList.remove('hidden');
            document.getElementById('challenge-section').classList.add('hidden');
            document.getElementById('result-section').classList.add('hidden');
            
            currentChallengeId = null;
        }
        
        // Function to reset the entire game and points
        function resetEntireGame() {
            totalSessionPoints = 0;
            localStorage.setItem('totalSessionPoints', '0');
            updatePointsDisplay();
            resetGame();
        }
        
        // Initialize points display on page load
        updatePointsDisplay();
    </script>
</body>
</html>